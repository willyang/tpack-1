# 构建流程

## 构建目标
构建的目标是将 `src` 下的文件全部生成到 `dist`：

1. 有的文件需要直接复制，比如图片、字体；
2. 有的文件需要编译，比如 `.jsx` 编译成 `.js`；
3. 有的文件编译后生成多个文件，比如 `.tsx` 编译成 `.js` 和 `.d.ts`；
4. 文件之间有引用关系，比如 HTML 引了 `.jsx` 文件，构建后 `.jsx` 文件变成了 `.js`，HTML 的引用地址也要同步更新；
5. 有的文件需要提取公共文件，比如自动产生 `vendors.js`；
6. 上线时，有的文件需要额外压缩、优化，比如 `.js` 和 `.css`；
7. 上线时，需要给文件路径加哈希值，避免用户缓存；
8. 开发时，要支持文件监听并自动重新生成该文件；
9. 开发时，支持按需生成，用户需要用到的优先生成。

根据以上需求，引入模块（Module）的概念：
- 模块可以代表一个物理文件，也可以代表生成的临时文件；
- 模块有“路径”和“内容”两个属性，用户可以反复读写这两个属性，然后根据最终的状态保存到 `dist`；
- 模块之间有依赖关系，且可能存在循环依赖；
- 模块需要缓存，以便开发时不重复生成相同模块。

## 构建流程

### 1. 扫描文件列表
扫描 `src` 下的所有文件，每个文件创建一个入口模块，得到所有入口模块组成的数组。

扫描时根据通配符过滤某些不参与构建的文件。

必须等模块都扫描完再继续后续构建流程，为了防止后续流程生成新文件，新文件又被扫描并递归运行后续流程，导致无限循环。
这意味着如果在构建的期间新建了文件，新文件不会被构建，需要重新构建。

### 2. 加载模块
遍历所有入口模块，**并行地**加载入口模块，加载分四步：

#### 2.1 读取模块
从硬盘读取模块源码，保存到模块的“内容”属性。

读取一个多大的文件就会占用多大的内存，所以并不是所有文件都要读取，而是等待首次需要时再读取，未读取的模块的“内容”值为 undefined。

#### 2.2 编译模块
按顺序执行编译器插件，插件会更新模块的“路径”和“内容”。当编译器都执行完结束后，模块的当前“内容”就是编译后的结果。

#### 2.3 解析模块
每一个模块都会绑定一个打包器，这个打包器可以在编译期间由插件绑定。如果没绑定或绑定为 `false`，则这个模块不打包，`.js/.css/.html` 文件如果没绑定过，系统会绑定自带的打包器。

使用打包器解析模块，得到依赖列表。

#### 2.4 加载依赖
遍历模块的所有依赖，解析依赖对应的绝对路径（比如 react 解析成 node_modules 里的位置）。如果这个绝对路径没有加载过，则递归加载。

直到所有模块和依赖的依赖都加载完成，加载阶段才会结束。

### 3. 提取公共
遍历所有入口模块，根据“公共模块提取策略”计算哪些依赖需要提取公共模块。

提取的公共模块后会被加入到入口模块数组。

### 4. 生成模块
遍历所有入口模块，**串行地**生成每个模块，生成分四步：

> 之所以串行，是因为：
> 1. 为了避免处理循环依赖问题；
> 2. 生成阶段一般不会读写硬盘，对单线程的 Node.js 来说，串行和并行性能差别不大。

#### 4.1 合成模块
使用打包器合成模块最终的代码，保存到模块的“内容”属性。

#### 4.2 优化模块
按顺序执行用户设置的优化器插件，具体流程同编译模块。

#### 4.3 复制外部模块
如果是外部模块，则根据用户设置的“外部模块策略”计算复制到项目里的路径，如果没有复制，则模块按内联处理。

#### 4.4 提交模块
将模块记录到生成模块缓存，避免下次重复生成。

如果模块存在兄弟模块，则将兄弟模块一并提交。

### 5. 保存模块
遍历每个入口模块，保存模块到硬盘。

保存时会将模块的路径从 `src` 移动到 `dist`。

如果模块存在兄弟模块，则将兄弟模块一并保存。

### 6. 报告详情
根据用户设置的“报告器”，生成这次打包的报告。